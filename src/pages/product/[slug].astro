---
import Layout from '../../layouts/Layout.astro';
import { getProductBySlug, type Product } from '../../lib/db';
import { generateInternalBreadcrumbs } from '../../lib/csv';

const { slug } = Astro.params;

// Find product by slug
const product = await getProductBySlug(slug || '');

if (!product) {
  return Astro.redirect('/404');
}
const images = product.images ? product.images.split(',') : [];
const tags = product.tags ? product.tags.split(',') : [];
const displayTitle = product.optimized_title || product.title;
const displayDescription = product.optimized_description || product.description;
const referralTag = 'ref/16577150/?sharedfrom=pdp';
const referralUrl = product.url.replace(/\/$/, '') + '/' + referralTag;

// Generate internal breadcrumbs
const internalBreadcrumbs = generateInternalBreadcrumbs(product.category || null, product.subcategory || null);

// Enhanced Schema.org JSON-LD for SEO & AI Search (GEO)
const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": displayTitle,
  "description": displayDescription.replace(/<[^>]+>/g, ''), // Strip HTML
  "image": images,
  "url": `https://creativestuff.vercel.app/product/${slug}`,
  "category": product.category || "Design Resources",
  "keywords": tags.join(', '),
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock",
    "url": referralUrl,
    "priceValidUntil": "2026-12-31"
  },
  "brand": {
    "@type": "Brand",
    "name": "Creative Fabrica",
    "url": "https://www.creativefabrica.com"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Free Modern Creative Stuff",
    "url": "https://creativestuff.vercel.app"
  }
};

// BreadcrumbList schema for navigation context (helps AI understand site structure)
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://creativestuff.vercel.app"
    },
    product.category && {
      "@type": "ListItem",
      "position": 2,
      "name": product.category,
      "item": `https://creativestuff.vercel.app/category/${product.category.toLowerCase().replace(/\s+/g, '-')}`
    },
    product.subcategory && {
      "@type": "ListItem",
      "position": 3,
      "name": product.subcategory,
      "item": `https://creativestuff.vercel.app/category/${product.category?.toLowerCase().replace(/\s+/g, '-')}/${product.subcategory.toLowerCase().replace(/\s+/g, '-')}`
    },
    {
      "@type": "ListItem",
      "position": product.subcategory ? 4 : (product.category ? 3 : 2),
      "name": displayTitle
    }
  ].filter(Boolean)
};
---

<Layout title={`${displayTitle} - Free Modern Creative Stuff`} description={displayDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(productSchema)} is:inline />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} is:inline />
  <article class="container" itemscope itemtype="https://schema.org/Product">
    <div class="product-detail">
      <section class="product-images" aria-label="Product images">
        {images.map((img, index) => (
          <img
            src={img}
            alt={`${displayTitle} - Image ${index + 1}`}
            class="detail-image"
            width="600"
            height="400"
            loading={index === 0 ? "eager" : "lazy"}
            itemprop="image"
          />
        ))}
      </section>

      <section class="product-info">
        <nav class="breadcrumbs" set:html={internalBreadcrumbs} />

        <h1 class="detail-title">{displayTitle}</h1>

        <div class="detail-description" set:html={displayDescription} />

        <div class="detail-tags">
          {tags.map((tag: string) => (
            <span class="tag">{tag.trim()}</span>
          ))}
        </div>

        <button
          class="btn get-free-btn"
          data-url={product.url}
          data-referral={referralTag}
          style="margin-top: 24px;"
        >
          Get it for free
        </button>
      </section>
    </div>
  </article>

  <style>
    .product-detail {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 30px;
    }

    @media (max-width: 768px) {
      .product-detail {
        grid-template-columns: 1fr;
      }
    }

    .product-images {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detail-image {
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .breadcrumbs {
      font-size: 0.9rem;
      margin-bottom: 16px;
      color: #666;
    }

    .breadcrumbs :global(a) {
      color: #667eea;
      text-decoration: none;
    }

    .breadcrumbs :global(li) {
      display: inline;
      list-style: none;
    }

    .breadcrumbs :global(li):not(:last-child)::after {
      content: " / ";
      margin: 0 8px;
    }

    .detail-title {
      font-size: 2.5rem;
      margin-bottom: 24px;
      color: #333;
    }

    .detail-description {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #555;
      margin-bottom: 24px;
    }

    .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
  </style>

  <script>
    // Get it for free button functionality
    document.querySelector('.get-free-btn')?.addEventListener('click', (e) => {
      const button = e.target as HTMLButtonElement;
      const url = button.getAttribute('data-url');
      const referral = button.getAttribute('data-referral');

      if (url && referral) {
        const fullUrl = url.replace(/\/$/, '') + '/' + referral;
        window.open(fullUrl, '_blank');
      }
    });
  </script>
</Layout>
