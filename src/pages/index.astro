---
import Layout from '../layouts/Layout.astro';
import { getAllProducts, getAllCategories, type Product } from '../lib/db';
import { slugify } from '../lib/csv';

export const prerender = false;

let allProducts: Product[] = [];
let categories: string[] = [];
let error: string | null = null;

try {
  allProducts = await getAllProducts();
  categories = await getAllCategories();
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load products';
  console.error('Error loading products:', e);
}

// Pagination
const PRODUCTS_PER_PAGE = 20;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const totalProducts = allProducts.length;
const totalPages = Math.ceil(totalProducts / PRODUCTS_PER_PAGE);
const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
const endIndex = startIndex + PRODUCTS_PER_PAGE;
const products = allProducts.slice(startIndex, endIndex);

// Generate pagination page numbers
const paginationPages = Array.from({ length: totalPages }, (_, i) => i + 1).filter(pageNum => {
  return pageNum === 1 || pageNum === totalPages || (pageNum >= currentPage - 2 && pageNum <= currentPage + 2) || pageNum === currentPage - 3 || pageNum === currentPage + 3;
});

const referralTag = import.meta.env.REFERRAL_TAG || process.env.REFERRAL_TAG || 'ref/16577150/?sharedfrom=pdp';
---

<Layout title="Free Modern Creative Stuff - Fonts, Graphics & Design">
  <div class="container">
    <h1 class="visually-hidden">Free Creative Fonts, Graphics & Design Resources</h1>

    <section class="search-filter" aria-label="Product search">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Search for fonts, graphics, and designs..."
        aria-label="Search products"
      />
    </section>

    {error && (
      <div role="alert" style="background: #fee; padding: 20px; border-radius: 8px; color: #c00; margin-bottom: 20px;">
        Error: {error}
      </div>
    )}

    {products.length === 0 && !error && (
      <div style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
        <h2 style="margin-bottom: 16px;">No products available yet</h2>
        <p style="color: #666;">Check back soon for amazing free creative resources!</p>
      </div>
    )}

    <section class="product-grid" id="productGrid" aria-label="Product listings">
      {products.map((product) => {
        const images = product.images ? product.images.split(',') : [];
        const firstImage = images[0] || 'https://via.placeholder.com/300x200?text=No+Image';
        const tags = product.tags ? product.tags.split(',').slice(0, 3) : [];
        const displayTitle = product.optimized_title || product.title;
        const displayDescription = product.optimized_description || product.description;

        return (
          <article class="product-card" data-search={`${displayTitle} ${tags.join(' ')}`}>
            <a href={`/product/${product.slug}`} style="text-decoration: none; color: inherit;">
              <img
                src={firstImage}
                alt={displayTitle}
                class="product-image"
                width="300"
                height="200"
                loading="lazy"
              />
              <div class="product-content">
                <h2 class="product-title">{displayTitle}</h2>
                <div class="product-description" set:html={displayDescription} />
              <div class="product-tags">
                {tags.map((tag: string) => (
                  <span class="tag">{tag.trim()}</span>
                ))}
              </div>
              <button
                class="btn get-free-btn"
                data-url={product.url}
                data-referral={referralTag}
              >
                Get it for free
              </button>
            </div>
          </a>
        </article>
        );
      })}
    </section>

    {totalPages > 1 && (
      <div class="pagination">
        {currentPage > 1 && (
          <a href={`/?page=${currentPage - 1}`} class="pagination-btn">
            ← Previous
          </a>
        )}

        <div class="pagination-numbers">
          {paginationPages.map((pageNum, index) => {
            const showEllipsisBefore = index > 0 && paginationPages[index - 1] !== pageNum - 1;
            return (
              <>
                {showEllipsisBefore && <span class="pagination-ellipsis">...</span>}
                <a href={`/?page=${pageNum}`} class={`pagination-number ${pageNum === currentPage ? 'active' : ''}`}>{pageNum}</a>
              </>
            );
          })}
        </div>

        {currentPage < totalPages && (
          <a href={`/?page=${currentPage + 1}`} class="pagination-btn">
            Next →
          </a>
        )}
      </div>
    )}

    {categories.length > 0 && (
      <aside class="categories-nav" aria-label="Product categories" style="margin-top: 40px;">
        <h2 style="font-size: 1.2rem; margin-bottom: 16px; color: #333;">Browse by Category</h2>
        <nav class="categories-list" aria-label="Category links">
          {categories.map((cat) => (
            <a href={`/category/${slugify(cat)}`} class="category-badge">
              {cat}
            </a>
          ))}
        </nav>
      </aside>
    )}
  </div>

  <script>
    // Search functionality
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const productCards = document.querySelectorAll('.product-card');

    searchInput?.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();

      productCards.forEach((card) => {
        const searchData = card.getAttribute('data-search')?.toLowerCase() || '';
        const matches = searchData.includes(searchTerm);
        (card as HTMLElement).style.display = matches ? '' : 'none';
      });
    });

    // Get it for free button functionality
    document.querySelectorAll('.get-free-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const button = e.target as HTMLButtonElement;
        const url = button.getAttribute('data-url');
        const referral = button.getAttribute('data-referral');

        if (url && referral) {
          const fullUrl = url.replace(/\/$/, '') + '/' + referral;
          window.open(fullUrl, '_blank');
        }
      });
    });
  </script>
</Layout>
